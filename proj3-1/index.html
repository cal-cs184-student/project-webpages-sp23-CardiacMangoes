<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        CS 184 Project 3-1 Writeup - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@hackmd/emojify.js@2.1.0/dist/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i|Source+Code+Pro:300,400,500|Source+Sans+Pro:300,300i,400,400i,600,600i|Source+Serif+Pro&subset=latin-ext);.hljs{background:#fff;color:#333;display:block;overflow-x:auto;padding:.5em}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-string,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#a71d5d}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#0086b3}.hljs-built_in,.hljs-builtin-name{color:#005cc5}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#795da3}.hljs-addition{background-color:#eaffea;color:#55a532}.hljs-deletion{background-color:#ffecec;color:#bd2c00}.hljs-link{text-decoration:underline}.markdown-body{word-wrap:break-word;font-size:16px;line-height:1.5}.markdown-body:after,.markdown-body:before{content:"";display:table}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-bottom:16px;margin-top:0}.markdown-body hr{background-color:#e7e7e7;border:0;height:.25em;margin:24px 0;padding:0}.markdown-body blockquote{border-left:.25em solid #ddd;color:#777;font-size:16px;padding:0 1em}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body kbd,.popover kbd{background-color:#fcfcfc;border:1px solid;border-color:#ccc #ccc #bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb;color:#555;display:inline-block;font-size:11px;line-height:10px;padding:3px 5px;vertical-align:middle}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{border-bottom:1px solid #eee;padding-bottom:.3em}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{color:#777;font-size:.85em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{list-style-type:none;padding:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-bottom:0;margin-top:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{padding-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{font-size:1em;font-style:italic;font-weight:700;margin-top:16px;padding:0}.markdown-body dl dd{margin-bottom:16px;padding:0 16px}.markdown-body table{display:block;overflow:auto;width:100%;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{border:1px solid #ddd;padding:6px 13px}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{background-color:#fff;box-sizing:initial;max-width:100%}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{background-color:initial;max-width:none;vertical-align:text-top}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{border:1px solid #ddd;display:block;float:left;margin:13px 0 0;overflow:hidden;padding:7px;width:auto}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{clear:both;color:#333;display:block;padding:5px 0 0}.markdown-body span.align-center{clear:both;display:block;overflow:hidden}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{clear:both;display:block;overflow:hidden}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{background-color:#0000000a;border-radius:3px;font-size:85%;margin:0;padding:.2em 0}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{content:"\00a0";letter-spacing:-.2em}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{background:#0000;border:0;font-size:100%;margin:0;padding:0;white-space:pre;word-break:normal}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{background-color:#f7f7f7;border-radius:3px;font-size:85%;line-height:1.45;overflow:auto;padding:16px}.markdown-body pre code,.markdown-body pre tt{word-wrap:normal;background-color:initial;border:0;display:inline;line-height:inherit;margin:0;max-width:auto;overflow:visible;padding:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{font-size:12px;line-height:1;overflow:hidden;padding:5px;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{background:#fff;border:0;padding:10px 8px 9px;text-align:right}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{background:#f8f8f8;border-top:0;font-weight:700}.news .alert .markdown-body blockquote{border:0;padding:0 0 0 40px}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{cursor:default!important;float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle}.markdown-body{max-width:758px;overflow:visible!important;padding-bottom:40px;padding-top:40px;position:relative}.markdown-body .emoji{vertical-align:top}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{border-right:3px solid #6ce26c!important;box-sizing:initial;color:#afafaf!important;cursor:default;display:inline-block;min-width:20px;padding:0 8px 0 0;position:relative;text-align:right;z-index:4}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-bottom:none;border-left:none;border-top:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-collapse:inherit!important;border-spacing:0}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{margin-bottom:unset;overflow:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p:last-child{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram,.markdown-body pre.vega{background-color:inherit;border-radius:0;overflow:visible;text-align:center;white-space:inherit}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code,.markdown-body pre.vega>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg,.markdown-body pre.vega>svg{height:100%;max-width:100%}.markdown-body pre>code.wrap{word-wrap:break-word;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap}.markdown-body .alert>p:last-child,.markdown-body .alert>ul:last-child{margin-bottom:0}.markdown-body summary{display:list-item}.markdown-body summary:focus{outline:none}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none}.markdown-body figure{margin:1em 40px}.markdown-body .mark,.markdown-body mark{background-color:#fff1a7}.vimeo,.youtube{background-color:#000;background-position:50%;background-repeat:no-repeat;background-size:contain;cursor:pointer;display:table;overflow:hidden;text-align:center}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{object-fit:contain;width:100%;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{height:100%;left:0;position:absolute;top:0;width:100%}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{color:#fff;height:auto;left:50%;opacity:.3;position:absolute;top:50%;transform:translate(-50%,-50%);transition:opacity .2s;width:auto;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{bottom:0;height:100%;left:0;position:absolute;right:0;top:0;width:100%}.figma{display:table;padding-bottom:56.25%;position:relative;width:100%}.figma iframe{border:1px solid #eee;bottom:0;height:100%;left:0;position:absolute;right:0;top:0;width:100%}.markmap-container{height:300px}.markmap-container>svg{height:100%;width:100%}.MJX_Assistive_MathML{display:none}#MathJax_Message{z-index:1000!important}.ui-infobar{color:#777;margin:25px auto -25px;max-width:760px;position:relative;z-index:2}.toc .invisable-node{list-style-type:none}.ui-toc{bottom:20px;position:fixed;z-index:998}.ui-toc.both-mode{margin-left:8px}.ui-toc.both-mode .ui-toc-label{border-bottom-left-radius:0;border-top-left-radius:0;height:40px;padding:10px 4px}.ui-toc-label{background-color:#e6e6e6;border:none;color:#868686;transition:opacity .2s}.ui-toc .open .ui-toc-label{color:#fff;opacity:1;transition:opacity .2s}.ui-toc-label:focus{background-color:#ccc;color:#000;opacity:.3}.ui-toc-label:hover{background-color:#ccc;opacity:1;transition:opacity .2s}.ui-toc-dropdown{margin-bottom:20px;margin-top:20px;max-height:70vh;max-width:45vw;overflow:auto;padding-left:10px;padding-right:10px;text-align:inherit;width:25vw}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{letter-spacing:.0029em;padding-right:0}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{color:#767676;display:block;font-size:13px;font-weight:500;padding:4px 20px}.ui-toc-dropdown .nav>li:first-child:last-child>ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{background-color:initial;border-left:1px solid #000;color:#000;padding-left:19px;text-decoration:none}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{border-left:none;border-right:1px solid #000;padding-right:19px}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{background-color:initial;border-left:2px solid #000;color:#000;font-weight:700;padding-left:18px}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{border-left:none;border-right:2px solid #000;padding-right:18px}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{font-size:12px;font-weight:400;padding-bottom:1px;padding-left:30px;padding-top:1px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{font-size:12px;font-weight:400;padding-bottom:1px;padding-left:40px;padding-top:1px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{font-weight:500;padding-left:28px}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{font-weight:500;padding-left:38px}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html[lang^=ja] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ ゴシック,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html[lang=zh-tw] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html[lang=zh-cn] .markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html .markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ ゴシック,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html .markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html .markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Helvetica,Roboto,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}html[lang^=ja] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,ＭＳ Ｐゴシック,sans-serif}html[lang=zh-tw] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,微軟正黑UI,sans-serif}html[lang=zh-cn] .ui-toc-dropdown{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,微软雅黑UI,sans-serif}html .ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,ＭＳ Ｐゴシック,sans-serif}html .ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,微軟正黑UI,sans-serif}html .ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,微软雅黑UI,sans-serif}.ui-affix-toc{max-height:70vh;max-width:15vw;overflow:auto;position:fixed;top:0}.back-to-top,.expand-toggle,.go-to-bottom{color:#999;display:block;font-size:12px;font-weight:500;margin-left:10px;margin-top:10px;padding:4px 10px}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{background-position:50%;background-repeat:no-repeat;background-size:cover;border-radius:50%;display:block;height:20px;margin-bottom:2px;margin-right:5px;margin-top:2px;width:20px}.ui-user-icon.small{display:inline-block;height:18px;margin:0 0 .2em;vertical-align:middle;width:18px}.ui-infobar>small>span{line-height:22px}.ui-infobar>small .dropdown{display:inline-block}.ui-infobar>small .dropdown a:focus,.ui-infobar>small .dropdown a:hover{text-decoration:none}.ui-more-info{color:#888;cursor:pointer;vertical-align:middle}.ui-more-info .fa{font-size:16px}.ui-connectedGithub,.ui-published-note{color:#888}.ui-connectedGithub{line-height:23px;white-space:nowrap}.ui-connectedGithub a.file-path{color:#888;padding-left:22px;text-decoration:none}.ui-connectedGithub a.file-path:active,.ui-connectedGithub a.file-path:hover{color:#888;text-decoration:underline}.ui-connectedGithub .fa{font-size:20px}.ui-published-note .fa{font-size:20px;vertical-align:top}.unselectable{-webkit-user-select:none;-o-user-select:none;user-select:none}.selectable{-webkit-user-select:text;-o-user-select:text;user-select:text}.inline-spoiler-section{cursor:pointer}.inline-spoiler-section .spoiler-text{background-color:#333;border-radius:2px}.inline-spoiler-section .spoiler-text>*{opacity:0}.inline-spoiler-section .spoiler-img{filter:blur(10px)}.inline-spoiler-section.raw{background-color:#333;border-radius:2px}.inline-spoiler-section.raw>*{opacity:0}.inline-spoiler-section.unveil{cursor:auto}.inline-spoiler-section.unveil .spoiler-text{background-color:#3333331a}.inline-spoiler-section.unveil .spoiler-text>*{opacity:1}.inline-spoiler-section.unveil .spoiler-img{filter:none}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{color:#222;position:relative;z-index:1}.markdown-body.slides:before{background-color:currentColor;bottom:0;box-shadow:0 0 0 50vw;content:"";display:block;left:0;position:absolute;right:0;top:0;z-index:-1}.markdown-body.slides section[data-markdown]{background-color:#fff;margin-bottom:1.5em;position:relative;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{left:1em;max-height:100%;overflow:hidden;position:absolute;right:1em;top:50%;transform:translateY(-50%)}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{border:3px solid #777;content:"";height:1.5em;position:absolute;right:1em;top:-1.5em}.site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,sans-serif}html[lang^=ja] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ ゴシック,sans-serif}html[lang=zh-tw] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html[lang=zh-cn] .site-ui-font{font-family:Source Sans Pro,Helvetica,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}html[lang^=ja] body{font-family:Source Sans Pro,Helvetica,Arial,Hiragino Kaku Gothic Pro,ヒラギノ角ゴ Pro W3,Osaka,Meiryo,メイリオ,MS Gothic,ＭＳ ゴシック,sans-serif}html[lang=zh-tw] body{font-family:Source Sans Pro,Helvetica,Arial,PingFang TC,Microsoft JhengHei,微軟正黑,sans-serif}html[lang=zh-cn] body{font-family:Source Sans Pro,Helvetica,Arial,PingFang SC,Microsoft YaHei,微软雅黑,sans-serif}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}abbr[data-original-title],abbr[title]{cursor:help}body.modal-open{overflow-y:auto;padding-right:0!important}svg{text-shadow:none}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid comment-enabled comment-inner" data-hard-breaks="true"><h1 id="CS-184-Project-3-1-Writeup" data-id="CS-184-Project-3-1-Writeup"><a class="anchor hidden-xs" href="#CS-184-Project-3-1-Writeup" title="CS-184-Project-3-1-Writeup"><span class="octicon octicon-link"></span></a><span>CS 184 Project 3-1 Writeup</span></h1><p><span>Tianchen Liu 3034681144, Riley Peterlinz 3036754368</span></p><p><span>Link:</span><br>
<a href="https://cal-cs184-student.github.io/project-webpages-sp23-CardiacMangoes/proj3-1/index.html" target="_blank" rel="noopener"><span>https://cal-cs184-student.github.io/project-webpages-sp23-CardiacMangoes/proj3-1/index.html</span></a></p><h2 id="Overview" data-id="Overview"><a class="anchor hidden-xs" href="#Overview" title="Overview"><span class="octicon octicon-link"></span></a><span>Overview</span></h2><p><span>In Part 1, we first generate rays that shoots through the camera into the scene Then we calculate intersections between the rays and the primatives. We write methods to cacluate ray-triangle intersection and ray-sphere intersection.</span></p><p><span>Then in Part 2, we implement BVH optimization to speed up calculations of ray-primative intersections by preprocessing the primatives into bounding boxes.</span></p><p><span>Then in Part 3, we deal with illumination and implement direct lighting. We implement direct lighting in two ways: uniform hemisphere sampling and lighting sampling. As we can see, lighting sampling creates less noisy pictures.</span></p><p><span>For part 4, we implemented multiple bounces for indirect lighting. Then, for part 5 we used adaptive sampling to intelligently sample different parts of the image depending on the variance of their sampled distributions, leading to faster rendering times for high sampled scenes.</span></p><h2 id="Part-1" data-id="Part-1"><a class="anchor hidden-xs" href="#Part-1" title="Part-1"><span class="octicon octicon-link"></span></a><span>Part 1</span></h2><blockquote>
<p><span>Walk through the ray generation and primitive intersection parts of the rendering pipeline.</span></p>
</blockquote><p><span>For each pixel on the screen, the camera generates a ray that “shoots through the pixel from the camera”.</span></p><p><span>For each location on the screen, we first imagine there’s a virtual camera sensor in the world, and each location on the screen would translate to a location/coordinate on the censor. Then we translate a pixel to that coordinate on the virtual censor. Then we generate a ray that starts from the camera position, shoots in the direction of coordinate in the virtual censor. The origin is the position of the camera, the direction vector is the vector that starts from origin and ends in the location of the corresponding location on the sensor (but normalized). We assign the max_t and the min_t.</span></p><p><img src="https://i.imgur.com/1fylUvB.png" alt="" loading="lazy"></p><p><span>The code to do it is as follows:</span></p><pre><code class="wrap cpp hljs">  <span class="token comment">// vec is direction vector</span>
  <span class="token keyword">auto</span> vec <span class="token operator">=</span> <span class="token function">Vector3D</span><span class="token punctuation">(</span><span class="token function">tan</span><span class="token punctuation">(</span>PI<span class="token operator">/</span><span class="token number">180</span><span class="token operator">*</span>hFov<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> 
                      <span class="token function">tan</span><span class="token punctuation">(</span>PI<span class="token operator">/</span><span class="token number">180</span><span class="token operator">*</span>vFov<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>y<span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> 
                      <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vec<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> ray <span class="token operator">=</span> <span class="token function">Ray</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> c2w<span class="token operator">*</span>vec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ray<span class="token punctuation">.</span>max_t <span class="token operator">=</span> fClip<span class="token punctuation">;</span>
  ray<span class="token punctuation">.</span>min_t <span class="token operator">=</span> nClip<span class="token punctuation">;</span>
  <span class="token keyword">return</span> ray<span class="token punctuation">;</span>
</code></pre><p><span>Now we know how to shoot a ray from the camera to a location on the vitual censor, for every pixel on the image space, we sample </span><code>ns_aa</code><span> rays that shoots through that pixel (or the equivalent to where that pixel would be in the virtual sensor) from the camera.</span></p><pre><code class="wrap cpp hljs">  <span class="token keyword">int</span> num_samples <span class="token operator">=</span> ns_aa<span class="token punctuation">;</span>          <span class="token comment">// total samples to evaluate</span>
  Vector2D origin <span class="token operator">=</span> <span class="token function">Vector2D</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bottom left corner of the pixel</span>
  <span class="token keyword">auto</span> sampler <span class="token operator">=</span> <span class="token function">UniformGridSampler2D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Vector3D ret<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num_samples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> sample_point <span class="token operator">=</span> origin <span class="token operator">+</span> sampler<span class="token punctuation">.</span><span class="token function">get_sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    Vector2D normalized_sample_point = {sample_point.x / sampleBuffer.w, sample_point.y / sampleBuffer.h};</span>
    <span class="token keyword">auto</span> ray <span class="token operator">=</span> camera<span class="token operator">-&gt;</span><span class="token function">generate_ray</span><span class="token punctuation">(</span>sample_point<span class="token punctuation">.</span>x <span class="token operator">/</span> sampleBuffer<span class="token punctuation">.</span>w<span class="token punctuation">,</span> sample_point<span class="token punctuation">.</span>y <span class="token operator">/</span> sampleBuffer<span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">+=</span> <span class="token function">est_radiance_global_illumination</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  sampleBuffer<span class="token punctuation">.</span><span class="token function">update_pixel</span><span class="token punctuation">(</span>ret <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span>num_samples<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sampleCountBuffer<span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token operator">*</span> sampleBuffer<span class="token punctuation">.</span>w<span class="token punctuation">]</span> <span class="token operator">=</span> num_samples<span class="token punctuation">;</span>
</code></pre><blockquote>
<p><span>Explain the triangle intersection algorithm you implemented in your own words.</span></p>
</blockquote><p><span>We first implement the Moller-Trumbore algorithm taught in lecture</span></p><pre><code class="wrap cpp hljs">tuple<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">&gt;</span> <span class="token function">MollerTrumbore</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> Vector3D p1<span class="token punctuation">,</span> Vector3D p2<span class="token punctuation">,</span> Vector3D p3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> E1 <span class="token operator">=</span> p1 <span class="token operator">-</span> p3<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> E2 <span class="token operator">=</span> p2 <span class="token operator">-</span> p3<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> S <span class="token operator">=</span> r<span class="token punctuation">.</span>o <span class="token operator">-</span> p3<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> S1 <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>d<span class="token punctuation">,</span> E2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> S2 <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> coeff <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token function">dot</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> E1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> t <span class="token operator">=</span> coeff <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>S2<span class="token punctuation">,</span> E2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> b1 <span class="token operator">=</span> coeff <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>S1<span class="token punctuation">,</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> b2 <span class="token operator">=</span> coeff <span class="token operator">*</span> <span class="token function">dot</span><span class="token punctuation">(</span>S2<span class="token punctuation">,</span> r<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>t<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> b2<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><span>This algorithm takes in a ray and three vertices of the triangle and returns the </span><code>t</code><span> for the intersection of the ray and the triangle as well as the barycentric coordinates </span><code>b1</code><span> and </span><code>b2</code><span>.</span></p><p><span>We first check the </span><code>t</code><span> returned is within </span><code>min_t</code><span> and </span><code>max_t</code><span> of the ray:</span></p><pre><code class="wrap cpp hljs"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> t <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>min_t <span class="token operator">&lt;=</span> t <span class="token operator">&amp;&amp;</span> t <span class="token operator">&lt;=</span> r<span class="token punctuation">.</span>max_t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ray does not shine on plane</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><p><span>Now we check if the barycentric coordinates are valid (inside triangle):</span></p><pre><code class="wrap cpp hljs"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> b1 <span class="token operator">&amp;&amp;</span> b1 <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> b2 <span class="token operator">&amp;&amp;</span> b2 <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b1 <span class="token operator">+</span> b2 <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><p><span>If so, we set the </span><code>max_t</code><span> of all the ray to be </span><code>t</code><span> and assign values to the intersection accordingly before returning true.</span></p><pre><code class="wrap cpp hljs">  r<span class="token punctuation">.</span>max_t <span class="token operator">=</span> t<span class="token punctuation">;</span>

  <span class="token comment">// The following is not needed if </span>
  isect<span class="token operator">-&gt;</span>t <span class="token operator">=</span> t<span class="token punctuation">;</span>
  <span class="token comment">// surface normal</span>
  isect<span class="token operator">-&gt;</span>n <span class="token operator">=</span> b1 <span class="token operator">*</span> n1 <span class="token operator">+</span> b2 <span class="token operator">*</span> n2 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> b1 <span class="token operator">-</span> b2<span class="token punctuation">)</span> <span class="token operator">*</span> n3<span class="token punctuation">;</span>
  isect<span class="token operator">-&gt;</span>primitive <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  isect<span class="token operator">-&gt;</span>bsdf <span class="token operator">=</span> <span class="token function">get_bsdf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre><blockquote>
<p><span>Show images with normal shading for a few small .dae files.</span></p>
</blockquote><p><span>Cow:</span><br>
<img src="https://i.imgur.com/ewFP2Lt.png" alt="" loading="lazy"><br>
<span>Beetle:</span><br>
<img src="https://i.imgur.com/rV0vOsj.png" alt="" loading="lazy"><br>
<span>Teapot:</span><br>
<img src="https://i.imgur.com/msARC13.png" alt="" loading="lazy"></p><h2 id="Part-2" data-id="Part-2"><a class="anchor hidden-xs" href="#Part-2" title="Part-2"><span class="octicon octicon-link"></span></a><span>Part 2</span></h2><blockquote>
<p><span>Walk through your BVH construction algorithm. Explain the heuristic you chose for picking the splitting point.</span></p>
</blockquote><p><span>We use the average centroid method to find the splitting point.</span></p><ul>
<li><span>We first compute the average centroid of all bounding boxes of primatives, - then we find the longest axis,</span></li>
<li><span>Then we group primatives based on which side of the average centroid the primative is on along the longest axis</span></li>
</ul><p><span>Here’s our code. See comments for explanation/walkthrough.</span></p><pre><code class="wrap cpp hljs">  BBox bbox<span class="token punctuation">;</span>

  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Vector3D average_centroid<span class="token punctuation">;</span>

  <span class="token comment">// Compute average centroid:</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> p <span class="token operator">=</span> start<span class="token punctuation">;</span> p <span class="token operator">!=</span> end<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cnt<span class="token operator">++</span><span class="token punctuation">;</span>
    BBox bb <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get_bbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bbox<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    average_centroid <span class="token operator">+=</span> bb<span class="token punctuation">.</span><span class="token function">centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// If the number of primatives in this level of recursion is less than max_leaf_size, then this is the base case and we should return a BVHNode with null L and R pointers that corresponds to this bounding box and these primatives.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">&lt;=</span> max_leaf_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHNode</span><span class="token punctuation">(</span>bbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
    node<span class="token operator">-&gt;</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Decide what's the longest axis of the current bounding box.</span>
  average_centroid <span class="token operator">/=</span> cnt<span class="token punctuation">;</span>
  <span class="token keyword">double</span> delta_x <span class="token operator">=</span> bbox<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
  <span class="token keyword">double</span> delta_y <span class="token operator">=</span> bbox<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
  <span class="token keyword">double</span> delta_z <span class="token operator">=</span> bbox<span class="token punctuation">.</span>extent<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> x_longest <span class="token operator">=</span> <span class="token punctuation">(</span>delta_x <span class="token operator">&gt;=</span> delta_y <span class="token operator">&amp;&amp;</span> delta_x <span class="token operator">&gt;=</span> delta_z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> y_longest <span class="token operator">=</span> <span class="token punctuation">(</span>delta_y <span class="token operator">&gt;=</span> delta_x <span class="token operator">&amp;&amp;</span> delta_y <span class="token operator">&gt;=</span> delta_z<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> z_longest <span class="token operator">=</span> <span class="token punctuation">(</span>delta_z <span class="token operator">&gt;=</span> delta_x <span class="token operator">&amp;&amp;</span> delta_z <span class="token operator">&gt;=</span> delta_y<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If the primative is on the "&lt;=" side, then put it in the left vector.</span>
  <span class="token comment">// Otherwise put it in the right vector</span>
  vector<span class="token operator">&lt;</span>Primitive <span class="token operator">*</span><span class="token operator">&gt;</span> left<span class="token punctuation">;</span>
  vector<span class="token operator">&lt;</span>Primitive <span class="token operator">*</span><span class="token operator">&gt;</span> right<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> p <span class="token operator">=</span> start<span class="token punctuation">;</span> p <span class="token operator">!=</span> end<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> centroid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get_bbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">centroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x_longest <span class="token operator">&amp;&amp;</span> centroid<span class="token punctuation">.</span>x <span class="token operator">&lt;=</span> average_centroid<span class="token punctuation">.</span>x <span class="token operator">||</span> y_longest <span class="token operator">&amp;&amp;</span> centroid<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> average_centroid<span class="token punctuation">.</span>y <span class="token operator">||</span> z_longest <span class="token operator">&amp;&amp;</span> centroid<span class="token punctuation">.</span>z <span class="token operator">&lt;=</span> average_centroid<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      left<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      right<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Reorder the primatives vector so that all left primatives come before right primatives.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> left<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>start<span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> left<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> right<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>start <span class="token operator">+</span> left<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> right<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Assign start and end pointers of the node. The left node should be constructed with primatives in the left vector, and the right node should be constructed with primatives in the right vector.</span>
  <span class="token keyword">auto</span> <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BVHNode</span><span class="token punctuation">(</span>bbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token operator">-&gt;</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
  node<span class="token operator">-&gt;</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>
  node<span class="token operator">-&gt;</span>l <span class="token operator">=</span> <span class="token function">construct_bvh</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> start <span class="token operator">+</span> left<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_leaf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  node<span class="token operator">-&gt;</span>r <span class="token operator">=</span> <span class="token function">construct_bvh</span><span class="token punctuation">(</span>start <span class="token operator">+</span> left<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">,</span> max_leaf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> node<span class="token punctuation">;</span>
</code></pre><blockquote>
<p><span>Show images with normal shading for a few large .dae files that you can only render with BVH acceleration.</span></p>
</blockquote><p><img src="https://i.imgur.com/k4T5Mb9.png" alt="" loading="lazy"><br>
<img src="https://i.imgur.com/9Q8ufKB.png" alt="" loading="lazy"><br>
<img src="https://i.imgur.com/WnYcLJg.png" alt="" loading="lazy"><br>
<img src="https://i.imgur.com/bR3baaL.png" alt="" loading="lazy"></p><blockquote>
<p><span>Compare rendering times on a few scenes with moderately complex geometries with and without BVH acceleration. Present your results in a one-paragraph analysis.</span></p>
</blockquote><p><span>The time it takes to collect primatives is roughly the same for both methods (around 0.0011 seconds). The time it takes to build BVH from primatives is, of course, longer for BVH, (0.0027 seconds for BVH vs 0.0001 seconds for naive solution). But this difference of time is negligible in the grand scheme of things. The time it takes to render is a lot longer for the naive method. It takes on average 63.8475 seconds without BVH acceleration and 0.0704 seconds with BVH acceleration. The average rays/second is of course, inverse to this ratio because the amount of rays stays the same. This is because the average intersection tests for a ray is drastically decreased. Without BVH acceleration it does 2.95974625 intersection tests per ray on average, but with BVH acceleration it does 1367.904394 intersection tests per ray on average.</span></p><h2 id="Part-3" data-id="Part-3"><a class="anchor hidden-xs" href="#Part-3" title="Part-3"><span class="octicon octicon-link"></span></a><span>Part 3</span></h2><blockquote>
<p><span>Walk through both implementations of the direct lighting function.</span><br>
<span>Show some images rendered with both implementations of the direct lighting function.</span></p>
</blockquote><p><span>Hemisphere sampling:</span></p><p><span>We obtain the intersection between the ray and the primative first. Then we sample </span><code>num_samples</code><span> directions uniformly at random on the hemisphere in the direction of the normal of the intersection. We then generate a ray that starts from the intersection and shoots in this direction. We then obtain the emission from the new intersection (see if this reflection ray intersects a light source), and if so, the total should add the emission obtained from the camera from this ray and its reflection using this reflection equation: </span><a href="https://cs184.eecs.berkeley.edu/sp22/lecture/13-23/global-illumination-and-path-tra" target="_blank" rel="noopener"><span>https://cs184.eecs.berkeley.edu/sp22/lecture/13-23/global-illumination-and-path-tra</span></a><span> .The </span><code>sample.z</code><span> is the </span><code>cos(theta)</code><span> in this case. Then we divide the total summation of results by the number of samples.</span></p><pre><code class="wrap cpp hljs">  Vector3D result<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num_samples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> sample <span class="token operator">=</span> hemisphereSampler<span class="token operator">-&gt;</span><span class="token function">get_sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> ray_after_bounce <span class="token operator">=</span> <span class="token function">Ray</span><span class="token punctuation">(</span>hit_p<span class="token punctuation">,</span> o2w <span class="token operator">*</span> sample<span class="token punctuation">,</span> r<span class="token punctuation">.</span>max_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ray_after_bounce<span class="token punctuation">.</span>min_t <span class="token operator">=</span> EPS_F<span class="token punctuation">;</span>
    Intersection isect_after_bounce<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> intersected <span class="token operator">=</span> bvh<span class="token operator">-&gt;</span><span class="token function">intersect</span><span class="token punctuation">(</span>ray_after_bounce<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isect_after_bounce<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>intersected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">+=</span> sample<span class="token punctuation">.</span>z <span class="token operator">*</span> isect_after_bounce<span class="token punctuation">.</span>bsdf<span class="token operator">-&gt;</span><span class="token function">get_emission</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> isect<span class="token punctuation">.</span>bsdf<span class="token operator">-&gt;</span><span class="token function">f</span><span class="token punctuation">(</span>w_out<span class="token punctuation">,</span> sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result <span class="token operator">/</span> num_samples<span class="token punctuation">;</span>

</code></pre><p><span>Importance sampling:</span></p><p><span>For importance sampling, we iterate over the lights in the scene and test intersection between our ray and the light. If there are no colisions, we sample from that light. This helps beecause now we are only sampling rays that would hit a light and thus the result has less noise since we are not sampling empty space that does not contribute light. For area lights we sample </span><code>ns_area_light</code><span> times, for point lights we only sample once since the ray to that light is the only ray that would hit from the point light. The amount of light being collected each sample is scaled by the bsdf and the angle between the light’s normal and the normal of the object at the point we are tracing. We also divide by the pdf of the sample for how important it is to the distribution.</span></p><pre><code class="wrap cpp hljs"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> light<span class="token operator">:</span> scene<span class="token operator">-&gt;</span>lights<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      Vector3D wi<span class="token punctuation">;</span> <span class="token comment">// direction between p and light source</span>
      <span class="token keyword">double</span> distToLight<span class="token punctuation">;</span> <span class="token comment">// distance between p and light source</span>
      <span class="token keyword">double</span> pdf<span class="token punctuation">;</span> <span class="token comment">// probability density function evaluated at the wi direction</span>

      Ray ray_after_bounce<span class="token punctuation">;</span>

      <span class="token keyword">float</span> costheta<span class="token punctuation">;</span> <span class="token comment">// angle between light source's and the ray shooting from p to light source</span>

      Vector3D L<span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> s <span class="token operator">&lt;</span> ns_area_light<span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Vector3D sample <span class="token operator">=</span> light<span class="token operator">-&gt;</span><span class="token function">sample_L</span><span class="token punctuation">(</span>hit_p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>distToLight<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdf<span class="token punctuation">)</span><span class="token punctuation">;</span>

          wi<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">auto</span> wi_object <span class="token operator">=</span> w2o <span class="token operator">*</span> wi<span class="token punctuation">;</span>

          costheta <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>wi<span class="token punctuation">,</span> isect<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>

          ray_after_bounce <span class="token operator">=</span> <span class="token function">Ray</span><span class="token punctuation">(</span>hit_p<span class="token punctuation">,</span> wi<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// assigns the location hit_p and direction wi of the next ray</span>

          ray_after_bounce<span class="token punctuation">.</span>max_t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> distToLight <span class="token operator">-</span> EPS_F<span class="token punctuation">;</span>
          ray_after_bounce<span class="token punctuation">.</span>min_t <span class="token operator">=</span> EPS_F<span class="token punctuation">;</span>

          Intersection isect_after_bounce<span class="token punctuation">;</span>

          <span class="token comment">// if ray hits light, add luminance</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>bvh<span class="token operator">-&gt;</span><span class="token function">intersect</span><span class="token punctuation">(</span>ray_after_bounce<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isect_after_bounce<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> costheta <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              L <span class="token operator">+=</span> sample <span class="token operator">*</span> isect<span class="token punctuation">.</span>bsdf<span class="token operator">-&gt;</span><span class="token function">f</span><span class="token punctuation">(</span>w_out<span class="token punctuation">,</span> wi<span class="token punctuation">)</span> <span class="token operator">*</span> costheta <span class="token operator">/</span> pdf<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>light<span class="token operator">-&gt;</span><span class="token function">is_delta_light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>light<span class="token operator">-&gt;</span><span class="token function">is_delta_light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          L_out <span class="token operator">+=</span> L<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          L_out <span class="token operator">+=</span> L <span class="token operator">/</span> <span class="token punctuation">(</span>ns_area_light<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>


  <span class="token keyword">return</span> L_out<span class="token punctuation">;</span>
</code></pre><p><span>Importance:</span><br>
<img src="https://i.imgur.com/8liEXV9.png" alt="" loading="lazy"><br>
<span>Hemisphere:</span><br>
<img src="https://i.imgur.com/q314Mje.png" alt="" loading="lazy"></p><p><span>Importance:</span><br>
<img src="https://i.imgur.com/upweG0x.png" alt="" loading="lazy"><br>
<span>Hemisphere:</span><br>
<img src="https://i.imgur.com/zyLFCPU.png" alt="" loading="lazy"></p><p><span>Importance:</span><br>
<img src="https://i.imgur.com/qOSgql7.png" alt="" loading="lazy"><br>
<span>Hemisphere:</span><br>
<span>N/A Because we can’t render point light source with Hemisphere sampling</span></p><blockquote>
<p><span>Focus on one particular scene with at least one area light and compare the noise levels in soft shadows when rendering with 1, 4, 16, and 64 light rays (the -l flag) and with 1 sample per pixel (the -s flag) using light sampling, not uniform hemisphere sampling.</span></p>
</blockquote><p><span>One light ray:</span><br>
<img src="https://i.imgur.com/5o9ZQuL.png" alt="" loading="lazy"><br>
<span>4 light ray:</span><br>
<img src="https://i.imgur.com/rT9CDXl.png" alt="" loading="lazy"><br>
<span>16 light ray:</span><br>
<img src="https://i.imgur.com/6QTV3Tm.png" alt="" loading="lazy"><br>
<span>64 light ray:</span><br>
<img src="https://i.imgur.com/cbjiCX1.png" alt="" loading="lazy"></p><p><span>The noise level decrease very noticably and the soft shadows gets much more realistic as the light rays amount goes up.</span></p><blockquote>
<p><span>Compare the results between uniform hemisphere sampling and lighting sampling in a one-paragraph analysis.</span></p>
</blockquote><p><span>First of all, uniform hemisphere sampling cannot render point light source. For area light source, hemisphere sampling generally produces a much more noisier image that’s somewhat darker because of the noise. The shadows for lighting sampling is smoother because of less noise as well. In general, lighting sampling creates a much more realistic image.</span></p><h2 id="Part-4" data-id="Part-4"><a class="anchor hidden-xs" href="#Part-4" title="Part-4"><span class="octicon octicon-link"></span></a><span>Part 4</span></h2><p><span>For Indirect Lighting we let a ray of light continuously bounce around a scene. The zero bounce is any emissive material. The first bounce is “direct lighting” from the light source onto the objects in the scene. Any more bounces is “indirect lighting” that occurs from light that bounces off a material and still has energy to illuminate other materials. We can sum the direct emission with direct and indicet lighting like so:</span></p><pre><code class="wrap cpp hljs">Vector3D <span class="token class-name">PathTracer</span><span class="token double-colon punctuation">::</span><span class="token function">est_radiance_global_illumination</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Intersection isect<span class="token punctuation">;</span>
  Vector3D L_out<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bvh<span class="token operator">-&gt;</span><span class="token function">intersect</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> L_out<span class="token punctuation">;</span>

    L_out <span class="token operator">=</span> <span class="token function">zero_bounce_radiance</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> isect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    L_out <span class="token operator">+=</span> <span class="token function">at_least_one_bounce_radiance</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> isect<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> L_out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><p><span>For indirect lighting, we recursively sample from the prior bounce’s location and direction. To make a proper estimator for the indirect lighting </span><code>L</code><span>, we have to first evaluate the BSDF’s reflectance </span><code>f</code><span> along with the a cosine term using the direction given from our sample </span><code>wi</code><span>, and covert those direction to world coordinates. We also scale by the </span><code>pdf</code><span> of the </span><code>sample_f</code><span> and the </span><code>cpdf</code><span> which is our normalization for russian roullete. The russian roullete randomly terminates</span></p><pre><code class="wrap cpp hljs">Vector3D <span class="token class-name">PathTracer</span><span class="token double-colon punctuation">::</span><span class="token function">at_least_one_bounce_radiance</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ray <span class="token operator">&amp;</span>r<span class="token punctuation">,</span>
                                                  <span class="token keyword">const</span> Intersection <span class="token operator">&amp;</span>isect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Matrix3x3 o2w<span class="token punctuation">;</span>
  <span class="token function">make_coord_space</span><span class="token punctuation">(</span>o2w<span class="token punctuation">,</span> isect<span class="token punctuation">.</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Matrix3x3 w2o <span class="token operator">=</span> o2w<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Vector3D hit_p <span class="token operator">=</span> r<span class="token punctuation">.</span>o <span class="token operator">+</span> r<span class="token punctuation">.</span>d <span class="token operator">*</span> isect<span class="token punctuation">.</span>t<span class="token punctuation">;</span>
  Vector3D w_out <span class="token operator">=</span> w2o <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span>r<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Vector3D L_out<span class="token punctuation">;</span>

  L_out <span class="token operator">=</span> <span class="token function">one_bounce_radiance</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> isect<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">double</span> cpdf <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>

  Vector3D wi<span class="token punctuation">;</span>
  <span class="token keyword">double</span> pdf<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">coin_flip</span><span class="token punctuation">(</span>cpdf<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>depth <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Vector3D f <span class="token operator">=</span> isect<span class="token punctuation">.</span>bsdf<span class="token operator">-&gt;</span><span class="token function">sample_f</span><span class="token punctuation">(</span>w_out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">float</span> costheta <span class="token operator">=</span> wi<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
      Ray ray_after_bounce <span class="token operator">=</span> <span class="token function">Ray</span><span class="token punctuation">(</span>hit_p<span class="token punctuation">,</span> o2w <span class="token operator">*</span> wi<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ray_after_bounce<span class="token punctuation">.</span>depth <span class="token operator">=</span> r<span class="token punctuation">.</span>depth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

      ray_after_bounce<span class="token punctuation">.</span>min_t <span class="token operator">=</span> EPS_F<span class="token punctuation">;</span>

      Intersection isect_after_bounce<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>bvh<span class="token operator">-&gt;</span><span class="token function">intersect</span><span class="token punctuation">(</span>ray_after_bounce<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isect_after_bounce<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> costheta <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Vector3D L <span class="token operator">=</span> <span class="token function">at_least_one_bounce_radiance</span><span class="token punctuation">(</span>ray_after_bounce<span class="token punctuation">,</span> isect_after_bounce<span class="token punctuation">)</span><span class="token punctuation">;</span>
          L_out <span class="token operator">+=</span> L <span class="token operator">*</span> f <span class="token operator">*</span> costheta <span class="token operator">/</span> pdf <span class="token operator">/</span> cpdf<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> L_out<span class="token punctuation">;</span>
</code></pre><h3 id="Results" data-id="Results"><a class="anchor hidden-xs" href="#Results" title="Results"><span class="octicon octicon-link"></span></a><span>Results</span></h3><p><span>Here are two results rendered at 1024 samples</span><br>
<img src="https://i.imgur.com/b77JqZN.png" alt="" loading="lazy"><br>
<img src="https://i.imgur.com/zYrWpoU.png" alt="" loading="lazy"></p><p><span>The other results are the CBbunny.dae which is in the next sections</span></p><h3 id="Light-Bounce-Progression" data-id="Light-Bounce-Progression"><a class="anchor hidden-xs" href="#Light-Bounce-Progression" title="Light-Bounce-Progression"><span class="octicon octicon-link"></span></a><span>Light Bounce Progression</span></h3><p><span>Here we show the progression of the first three light bounces individually for </span><code>CBbunny.dae</code></p><p><span>0th Light Bounce</span><br>
<img src="https://i.imgur.com/wYrRcmM.png" alt="" loading="lazy"></p><p><span>1st Light Bounce (Direct Lighting)</span><br>
<img src="https://i.imgur.com/n3YlTX9.png" alt="" loading="lazy"></p><p><span>2nd Light Bounce (Inderect Lighting)</span><br>
<img src="https://i.imgur.com/lciLXnK.png" alt="" loading="lazy"></p><p><span>Indirect lighting has a lot less light since it only comes frrom diffuse sources, not direct illumination.</span></p><h3 id="Increasing-Depth" data-id="Increasing-Depth"><a class="anchor hidden-xs" href="#Increasing-Depth" title="Increasing-Depth"><span class="octicon octicon-link"></span></a><span>Increasing Depth</span></h3><p><span>Now, we can show how increasing the depth of bounces allows for more and more realistic lighting. I altered russian roulette to have a 100% chance for these renders continuing.</span></p><p><span>Depth = 0</span><br>
<img src="https://i.imgur.com/IqI53Lk.png" alt="" loading="lazy"></p><p><span>Depth = 1</span><br>
<img src="https://i.imgur.com/8ipNudh.png" alt="" loading="lazy"></p><p><span>Depth = 2</span><br>
<img src="https://i.imgur.com/gsOu4Qj.png" alt="" loading="lazy"></p><p><span>Depth = 3</span><br>
<img src="https://i.imgur.com/1n2RZpW.png" alt="" loading="lazy"></p><p><span>Depth = 100</span><br>
<img src="https://i.imgur.com/3lzYbeb.png" alt="" loading="lazy"></p><p><span>Notice that the result plateaus as depth increases. This is because the materials in the scene are all lambertian, making the energy of the light very weak so by the 100th bounce there is little light left to illuminate the scene.</span></p><p><span>We also increased the russian roullete progressively so that we are more likely to reach higher numbers of bounces. i.e </span><code>cpdf = 0.99</code><span> for 100 bounces.</span></p><h3 id="Sample-per-Pixel-Rates" data-id="Sample-per-Pixel-Rates"><a class="anchor hidden-xs" href="#Sample-per-Pixel-Rates" title="Sample-per-Pixel-Rates"><span class="octicon octicon-link"></span></a><span>Sample-per-Pixel Rates</span></h3><p><span>Here we vary samples to show how noise reduces. We use 4 light rays.</span></p><p><span>1 Sample</span><br>
<img src="https://i.imgur.com/2ETyJ0D.png" alt="" loading="lazy"></p><p><span>2 Samples</span><br>
<img src="https://i.imgur.com/iCytEai.png" alt="" loading="lazy"></p><p><span>4 Samples</span><br>
<img src="https://i.imgur.com/3IDlk1M.png" alt="" loading="lazy"></p><p><span>8 Samples</span><br>
<img src="https://i.imgur.com/kaHhfeX.png" alt="" loading="lazy"></p><p><span>16 Samples</span><br>
<img src="https://i.imgur.com/xNcyuYa.png" alt="" loading="lazy"></p><p><span>32 Samples</span><br>
<img src="https://i.imgur.com/iXnL5Gt.png" alt="" loading="lazy"></p><p><span>64 Samples</span><br>
<img src="https://i.imgur.com/VNvfccV.png" alt="" loading="lazy"></p><p><span>1024 Samples</span><br>
<img src="https://i.imgur.com/kAZnZ9f.png" alt="" loading="lazy"></p><p><span>As we expect, increasing samples allows for cleaner images.</span></p><h2 id="Part-5" data-id="Part-5"><a class="anchor hidden-xs" href="#Part-5" title="Part-5"><span class="octicon octicon-link"></span></a><span>Part 5</span></h2><p><span>With indirect lighting, our renders now look more realistic. However, they are still noisy for lower sample rates. We want high sample rates for locaticons that need it (like shadows) and low sample rates for locations that converge quickly. This is what adaptive sampling does.</span></p><p><span>We want to stop our sampling when we have a value that is within the 95% confidence interval around the mean of the samples </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-33-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03BC;</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-265" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-266" class="mjx-mrow"><span id="MJXc-Node-267" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.475em;">μ</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>μ</mi></math></span></span><script type="math/tex" id="MathJax-Element-33">\mu</script></span><span>.</span></p><p><span>Formally, we want the value </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-34-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>v</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-268" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-269" class="mjx-mrow"><span id="MJXc-Node-270" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">v</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>v</mi></math></span></span><script type="math/tex" id="MathJax-Element-34">v</script></span><span> of the pixel to be in between</span></p><p><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-35-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>&amp;#x03BC;</mi><mo>&amp;#x2212;</mo><mi>I</mi><mo>&amp;lt;</mo><mi>v</mi><mo>&amp;lt;</mo><mi>&amp;#x03BC;</mi><mo>+</mo><mi>I</mi></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-271" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-272" class="mjx-mrow"><span id="MJXc-Node-273" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.475em;">μ</span></span><span id="MJXc-Node-274" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">−</span></span><span id="MJXc-Node-275" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.064em;">I</span></span><span id="MJXc-Node-276" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.265em; padding-bottom: 0.37em;">&lt;</span></span><span id="MJXc-Node-277" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">v</span></span><span id="MJXc-Node-278" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.265em; padding-bottom: 0.37em;">&lt;</span></span><span id="MJXc-Node-279" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.475em;">μ</span></span><span id="MJXc-Node-280" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.318em; padding-bottom: 0.423em;">+</span></span><span id="MJXc-Node-281" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.064em;">I</span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>μ</mi><mo>−</mo><mi>I</mi><mo>&lt;</mo><mi>v</mi><mo>&lt;</mo><mi>μ</mi><mo>+</mo><mi>I</mi></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-35">\mu - I < v < \mu + I</script></span></p><p><span>Where </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-36-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>I</mi><mo>=</mo><mn>1.96</mn><mo>&amp;#x22C5;</mo><mfrac><mi>&amp;#x03C3;</mi><msqrt><mi>n</mi></msqrt></mfrac></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-282" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-283" class="mjx-mrow"><span id="MJXc-Node-284" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.064em;">I</span></span><span id="MJXc-Node-285" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.055em; padding-bottom: 0.318em;">=</span></span><span id="MJXc-Node-286" class="mjx-mn MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">1.96</span></span><span id="MJXc-Node-287" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.318em;">⋅</span></span><span id="MJXc-Node-288" class="mjx-mfrac MJXc-space2"><span class="mjx-box MJXc-stacked" style="width: 1.633em; padding: 0px 0.12em;"><span class="mjx-numerator" style="width: 1.633em; top: -1.133em;"><span id="MJXc-Node-289" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em; padding-right: 0.001em;">σ</span></span></span><span class="mjx-denominator" style="width: 1.633em; bottom: -1.084em;"><span id="MJXc-Node-290" class="mjx-msqrt"><span class="mjx-box" style="padding-top: 0.045em;"><span class="mjx-surd"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.528em; padding-bottom: 0.528em;">√</span></span><span class="mjx-box" style="padding-top: 0.236em; border-top-width: 1.4px; border-top-style: solid;"><span id="MJXc-Node-291" class="mjx-mrow"><span id="MJXc-Node-292" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span></span></span></span><span class="mjx-line" style="border-bottom-width: 1.3px; border-bottom-style: solid; top: -0.283em; width: 1.633em;"></span></span><span class="mjx-vsize" style="height: 2.217em; vertical-align: -1.084em;"></span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>I</mi><mo>=</mo><mn>1.96</mn><mo>⋅</mo><mfrac><mi>σ</mi><msqrt><mi>n</mi></msqrt></mfrac></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-36">I = 1.96 \cdot \frac{\sigma}{\sqrt{n}}</script></span></p><p><span>where </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-37-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03C3;</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-293" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-294" class="mjx-mrow"><span id="MJXc-Node-295" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em; padding-right: 0.001em;">σ</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi></math></span></span><script type="math/tex" id="MathJax-Element-37">\sigma</script></span><span> is the standard deviation of the points sampled and </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-38-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>n</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-296" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-297" class="mjx-mrow"><span id="MJXc-Node-298" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-38">n</script></span><span> is the number of samples.</span></p><p><span>We then terminate the sampling if</span><br>
<span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="mjx-chtml MJXc-display" style="text-align: center;"><span id="MathJax-Element-39-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>I</mi><mo>&amp;#x2264;</mo><mi>m</mi><mi>a</mi><mi>x</mi><mi>T</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>&amp;#x22C5;</mo><mi>&amp;#x03BC;</mi></math>" role="presentation" style="font-size: 119%; text-align: center; position: relative;"><span id="MJXc-Node-299" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-300" class="mjx-mrow"><span id="MJXc-Node-301" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.064em;">I</span></span><span id="MJXc-Node-302" class="mjx-mo MJXc-space3"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.475em;">≤</span></span><span id="MJXc-Node-303" class="mjx-mi MJXc-space3"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">m</span></span><span id="MJXc-Node-304" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-305" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">x</span></span><span id="MJXc-Node-306" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span><span id="MJXc-Node-307" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">o</span></span><span id="MJXc-Node-308" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em;">l</span></span><span id="MJXc-Node-309" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span><span id="MJXc-Node-310" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">r</span></span><span id="MJXc-Node-311" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-312" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-313" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">c</span></span><span id="MJXc-Node-314" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span><span id="MJXc-Node-315" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.003em; padding-bottom: 0.318em;">⋅</span></span><span id="MJXc-Node-316" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.475em;">μ</span></span></span></span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>I</mi><mo>≤</mo><mi>m</mi><mi>a</mi><mi>x</mi><mi>T</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>⋅</mo><mi>μ</mi></math></span></span></span><script type="math/tex; mode=display" id="MathJax-Element-39">I \leq maxTolerance \cdot \mu</script></span></p><p><span>Where </span><span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span id="MathJax-Element-40-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>m</mi><mi>a</mi><mi>x</mi><mi>T</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi></math>" role="presentation" style="font-size: 119%; position: relative;"><span id="MJXc-Node-317" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-318" class="mjx-mrow"><span id="MJXc-Node-319" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">m</span></span><span id="MJXc-Node-320" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-321" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">x</span></span><span id="MJXc-Node-322" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em; padding-right: 0.12em;">T</span></span><span id="MJXc-Node-323" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">o</span></span><span id="MJXc-Node-324" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.475em; padding-bottom: 0.265em;">l</span></span><span id="MJXc-Node-325" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span><span id="MJXc-Node-326" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">r</span></span><span id="MJXc-Node-327" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">a</span></span><span id="MJXc-Node-328" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">n</span></span><span id="MJXc-Node-329" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">c</span></span><span id="MJXc-Node-330" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.213em; padding-bottom: 0.265em;">e</span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>m</mi><mi>a</mi><mi>x</mi><mi>T</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi></math></span></span><script type="math/tex" id="MathJax-Element-40">maxTolerance</script></span><span> is a choice, usually arround 0.05.</span></p><p><span>We implement this in </span><code>raytrace_pixel</code><span> when looping over the samples. We check every </span><code>samplesPerBatch</code><span>, to not slow down the render too much. </span><code>s1</code><span> is a sum of the illuminations and </span><code>s2</code><span> is a sum of the illuminations squared.</span></p><pre><code class="wrap cpp hljs"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num_samples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> num_sampled<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> samplesPerBatch <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">float</span> mu <span class="token operator">=</span> s1 <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span>
          <span class="token keyword">float</span> var <span class="token operator">=</span> <span class="token punctuation">(</span>s2 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s1 <span class="token operator">*</span> s1<span class="token punctuation">)</span> <span class="token operator">/</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">float</span> I <span class="token operator">=</span> <span class="token number">1.96</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>var <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>I <span class="token operator">&lt;=</span> maxTolerance <span class="token operator">*</span> mu<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> sample_point <span class="token operator">=</span> origin <span class="token operator">+</span> gridSampler<span class="token operator">-&gt;</span><span class="token function">get_sample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> ray <span class="token operator">=</span> camera<span class="token operator">-&gt;</span><span class="token function">generate_ray</span><span class="token punctuation">(</span>sample_point<span class="token punctuation">.</span>x <span class="token operator">/</span> sampleBuffer<span class="token punctuation">.</span>w<span class="token punctuation">,</span> sample_point<span class="token punctuation">.</span>y <span class="token operator">/</span> sampleBuffer<span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ray<span class="token punctuation">.</span>depth <span class="token operator">=</span> max_ray_depth<span class="token punctuation">;</span>

    Vector3D radiance_est <span class="token operator">=</span> <span class="token function">est_radiance_global_illumination</span><span class="token punctuation">(</span>ray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> illum_est <span class="token operator">=</span> radiance_est<span class="token punctuation">.</span><span class="token function">illum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    s1 <span class="token operator">+=</span> illum_est<span class="token punctuation">;</span>
    s2 <span class="token operator">+=</span> illum_est <span class="token operator">*</span> illum_est<span class="token punctuation">;</span>

      radiance <span class="token operator">+=</span> radiance_est<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><p><span>We also need to make sure to normalize the final of illumination by the number of samples actually sampled, not the total number of samples possible!</span></p><pre><code class="wrap cpp hljs">sampleBuffer<span class="token punctuation">.</span><span class="token function">update_pixel</span><span class="token punctuation">(</span>radiance <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> num_sampled<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
sampleCountBuffer<span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token operator">*</span> sampleBuffer<span class="token punctuation">.</span>w<span class="token punctuation">]</span> <span class="token operator">=</span> num_sampled<span class="token punctuation">;</span>
</code></pre><h3 id="Results1" data-id="Results"><a class="anchor hidden-xs" href="#Results1" title="Results1"><span class="octicon octicon-link"></span></a><span>Results</span></h3><p><span>These renders were rendered with 2048 samples, 1 light ray, 5 max depth, and maxtolerance of 0.05.</span></p><p><span>Bunny Sample Rate</span><br>
<img src="https://i.imgur.com/7MwUHd9.png" alt="" loading="lazy"></p><p><span>Bunny Rendered Result</span><br>
<img src="https://i.imgur.com/YlGeL6e.png" alt="" loading="lazy"></p><p><span>Spheres Sample Rate</span><br>
<img src="https://i.imgur.com/piW9Jrs.png" alt="" loading="lazy"></p><p><span>Spheres Rendered Result</span><br>
<img src="https://i.imgur.com/Pl8FoNf.png" alt="" loading="lazy"></p><p><span>Notice in both the most samples are where the indirect lighting dominates. That being shadows and the ceiling.</span></p><h2 id="Collaboration" data-id="Collaboration"><a class="anchor hidden-xs" href="#Collaboration" title="Collaboration"><span class="octicon octicon-link"></span></a><span>Collaboration</span></h2><p><span>Tianchen coded parts 1 thru 3.3 and Riley coded parts 3.4 thru 5. We worked together on debugging individual parts.</span></p><p><span>This was the most interesting project so far since it does so many complex things that the results are often surprising.</span></p><p><span>Link:</span><br>
<a href="https://cal-cs184-student.github.io/project-webpages-sp23-CardiacMangoes/proj3-1/index.html" target="_blank" rel="noopener"><span>https://cal-cs184-student.github.io/project-webpages-sp23-CardiacMangoes/proj3-1/index.html</span></a></p></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav">
<li><a href="#CS-184-Project-3-1-Writeup" title="CS 184 Project 3-1 Writeup">CS 184 Project 3-1 Writeup</a><ul class="nav">
<li><a href="#Overview" title="Overview">Overview</a></li>
<li><a href="#Part-1" title="Part 1">Part 1</a></li>
<li><a href="#Part-2" title="Part 2">Part 2</a></li>
<li><a href="#Part-3" title="Part 3">Part 3</a></li>
<li><a href="#Part-4" title="Part 4">Part 4</a><ul class="nav">
<li><a href="#Results" title="Results">Results</a></li>
<li><a href="#Light-Bounce-Progression" title="Light Bounce Progression">Light Bounce Progression</a></li>
<li><a href="#Increasing-Depth" title="Increasing Depth">Increasing Depth</a></li>
<li><a href="#Sample-per-Pixel-Rates" title="Sample-per-Pixel Rates">Sample-per-Pixel Rates</a></li>
</ul>
</li>
<li><a href="#Part-5" title="Part 5">Part 5</a><ul class="nav">
<li><a href="#Results1" title="Results">Results</a></li>
</ul>
</li>
<li><a href="#Collaboration" title="Collaboration">Collaboration</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;" null null>
        <div class="toc"><ul class="nav">
<li><a href="#CS-184-Project-3-1-Writeup" title="CS 184 Project 3-1 Writeup">CS 184 Project 3-1 Writeup</a><ul class="nav">
<li><a href="#Overview" title="Overview">Overview</a></li>
<li><a href="#Part-1" title="Part 1">Part 1</a></li>
<li><a href="#Part-2" title="Part 2">Part 2</a></li>
<li><a href="#Part-3" title="Part 3">Part 3</a></li>
<li><a href="#Part-4" title="Part 4">Part 4</a><ul class="nav">
<li><a href="#Results" title="Results">Results</a></li>
<li><a href="#Light-Bounce-Progression" title="Light Bounce Progression">Light Bounce Progression</a></li>
<li><a href="#Increasing-Depth" title="Increasing Depth">Increasing Depth</a></li>
<li><a href="#Sample-per-Pixel-Rates" title="Sample-per-Pixel Rates">Sample-per-Pixel Rates</a></li>
</ul>
</li>
<li><a href="#Part-5" title="Part 5">Part 5</a><ul class="nav">
<li><a href="#Results1" title="Results">Results</a></li>
</ul>
</li>
<li><a href="#Collaboration" title="Collaboration">Collaboration</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
